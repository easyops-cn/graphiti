# 修改概览

| 文件 | 修改类型 | 说明 |
|------|---------|------|
| `graphiti_core/models/edges/edge_db_queries.py` | 新增函数 | 支持动态边类型的 Cypher 查询 |
| `graphiti_core/models/edges/edge_db_queries.py` | 逻辑修改 | MERGE 按节点对合并，避免重复边 |
| `graphiti_core/utils/bulk_utils.py` | 逻辑修改 | 按边类型分组保存 |
| `graphiti_core/utils/bulk_utils.py` | 新增函数 | 批量去重第三轮 LLM 语义去重 |
| `graphiti_core/utils/bulk_utils.py` | **架构重构** | **聚类去重：避免自匹配问题 + 按类型分组 + Map-Reduce** |
| `graphiti_core/prompts/dedupe_nodes.py` | **新增** | **EntityClustering 模型 + cluster_entities 提示词** |
| `graphiti_core/graphiti.py` | **性能优化** | **移除 resolve_extracted_nodes 调用，改用 semantic_dedupe_nodes_bulk** |
| `graphiti_core/search/search.py` | **Bug修复** | **Cross-encoder reranking 使用 name+summary 而非仅 name** |
| `graphiti_core/graphiti.py` | **性能优化** | **移除全局 DB 候选收集，由 Map 阶段按批处理** |
| `graphiti_core/utils/maintenance/edge_operations.py` | 逻辑修改 | 严格控制边类型，非 Schema 类型降级 |
| `graphiti_core/prompts/extract_nodes.py` | 新增 | Knowledge Graph Builder's Principles + filter_entities |
| `graphiti_core/utils/maintenance/node_operations.py` | 新增 | filter_extracted_nodes 函数（接收 EntityNode 含 summary） |
| `graphiti_core/graphiti.py` | 逻辑修改 | **Filter 步骤移到 extract_attributes 之后（获取 summary 后再过滤）** |
| `graphiti_core/llm_client/openai_generic_client.py` | 新增 | small_model 支持 |
| `graphiti_core/utils/maintenance/node_operations.py` | 逻辑修改 | 候选搜索按同实体类型过滤 |
| `graphiti_core/utils/maintenance/edge_operations.py` | 逻辑修改 | 候选搜索按同边类型过滤 |
| `graphiti_core/search/search_config.py` | 参数修改 | DEFAULT_SEARCH_LIMIT 从 10 改为 20 |
| `graphiti_core/prompts/dedupe_edges.py` | 新增字段 | EdgeDuplicate 添加 merged_fact 字段 |
| `graphiti_core/utils/maintenance/edge_operations.py` | 逻辑修改 | 边去重时合并 fact 和属性 |
| `graphiti_core/utils/maintenance/edge_operations.py` | 逻辑修改 | **边去重基于 (source, target, edge_type) 而非 fact** |
| `graphiti_core/prompts/dedupe_nodes.py` | 新增字段 | NodeDuplicate 添加 reasoning 字段 |
| `graphiti_core/prompts/dedupe_nodes.py` | Prompt优化 | 实体去重要求输出 reasoning，entity_type_definitions 独立 |
| `graphiti_core/utils/maintenance/node_operations.py` | 逻辑修改 | `_resolve_with_llm()` 独立提取类型定义，添加 reasoning 日志 |
| `graphiti_core/utils/maintenance/node_operations.py` | 容错处理 | **属性抽取枚举验证容错，移除无效字段而非崩溃** |
| `graphiti_core/prompts/extract_nodes.py` | Prompt优化 | **filter_entities 增加 Schema 实体类型上下文 + summary** |
| `graphiti_core/utils/maintenance/node_operations.py` | 参数传递 | filter_extracted_nodes 传入 entity_types_context |
| `graphiti_core/prompts/dedupe_nodes.py` | Prompt优化 | **基于属性的去重增强（code/model_id 相同即重复）** |
| `graphiti_core/prompts/extract_nodes.py` | 新增模型 | EntityReclassification 模型支持类型重新分类 |
| `graphiti_core/prompts/extract_nodes.py` | Prompt优化 | **filter_entities 支持类型重新验证和重新分类** |
| `graphiti_core/utils/maintenance/node_operations.py` | 返回类型 | filter_extracted_nodes 返回 (to_remove, to_reclassify) 元组 |
| `graphiti_core/graphiti.py` | 逻辑修改 | **处理误分类实体的类型更正** |
| `graphiti_core/prompts/extract_nodes.py` | 新增模型 | **两步验证: EntityValidationItem/Result** |
| `graphiti_core/prompts/extract_nodes.py` | 新增函数 | **validate_entity_types() 提示词（Step 1）** |
| `graphiti_core/utils/maintenance/node_operations.py` | 重构 | **filter_extracted_nodes 两步验证 + 批量并行（5实体/批）** |
| `graphiti_core/utils/maintenance/node_operations.py` | Bug修复 | **Step 2 不传 validation_reason 避免 LLM 偏向** |
| `graphiti_core/graphiti.py` | 逻辑修改 | **重新分类时同时更新 node.reasoning** |
| `graphiti_core/graphiti.py` | Bug修复 | **重新分类时清理旧类型属性，防止属性污染** |
| `graphiti_core/utils/bulk_utils.py` | Bug修复 | **批量保存补充 type_scores 和 type_confidence 字段** |
| `graphiti_core/prompts/extract_nodes.py` | 性能优化 | **实体类型打分从全量改为 Top 3 候选，减少 token 消耗** |
| `graphiti_core/prompts/extract_nodes.py` | 新增函数 | **resolve_ambiguous_types() 批量二次推理** |
| `graphiti_core/utils/maintenance/node_operations.py` | 逻辑修改 | **两阶段类型分类：Top 3 打分 + 歧义消解** |
| `graphiti_core/utils/maintenance/node_operations.py` | 性能优化 | **实体去重分批并行处理，避免 LLM 输出截断** |
| `graphiti_core/helpers.py` | Bug修复 | **lucene_sanitize 添加反引号转义，修复 RediSearch 语法错误** |
| `graphiti_core/utils/maintenance/node_operations.py` | 容错处理 | **_extract_attributes_and_update 添加异常捕获，单实体失败不影响整批** |
| `graphiti_core/utils/bulk_utils.py` | **Bug修复** | **批量去重传递 entity_type_definitions，启用别名匹配** |
| `graphiti_core/prompts/dedupe_nodes.py` | **Prompt增强** | **nodes() 添加别名匹配指导，识别 "或" 分隔的别名** |
| `graphiti_core/prompts/extract_nodes.py` | **功能增强** | **反思环节增加负向反思：识别不该抽取的实体、类型错误的实体** |
| `graphiti_core/prompts/extract_edges.py` | **功能增强** | **反思环节增加负向反思：识别不正确的关系、类型错误的关系** |
| `graphiti_core/utils/maintenance/node_operations.py` | 逻辑修改 | **extract_nodes_reflexion 处理负向反思结果** |
| `graphiti_core/utils/maintenance/edge_operations.py` | 逻辑修改 | **extract_edges 反思处理负向反思结果** |
| `graphiti_core/prompts/extract_nodes.py` | **性能优化** | **批量 Summary 提取：EntitySummaries 模型 + extract_summaries_bulk 提示词** |
| `graphiti_core/utils/maintenance/node_operations.py` | **性能优化** | **_extract_entity_summaries_bulk 批量提取 + extract_attributes_from_nodes 改用批量** |
| `scripts/cleanup_duplicate_nodes.py` | **新增脚本** | **离线清理重复节点：用 LLM 识别并合并数据库中的历史重复数据** |
| `graphiti_core/prompts/dedupe_nodes.py` | **Prompt增强** | **cluster_entities() 防止相反操作被错误分组（backup vs restore）** |
| `graphiti_core/search/search_utils.py` | **Bug修复** | **BFS 遍历所有边类型，而非仅 RELATES_TO\|MENTIONS** |
| `graphiti_core/search/search_config_recipes.py` | **功能增强** | **COMBINED_HYBRID_SEARCH_RRF 启用 BFS（无需 reranker 也能多跳检索）** |
| `graphiti_core/models/nodes/node_db_queries.py` | **Bug修复** | **FalkorDB 批量保存: 避免 SET n = node 导致 embedding 存储为 List** |

---
